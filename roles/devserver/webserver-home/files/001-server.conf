#   -------------------------------------------------------------
#   Nginx :: server homepage and home directories
#   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#   Project:        Nasqueron
#   License:        Trivial work, not eligible to copyright
#   Source file:    roles/devserver/webserver-home/files/001-server.conf
#   -------------------------------------------------------------
#
#   <auto-generated>
#       This file is managed by our rOPS SaltStack repository.
#
#       Changes to this file may cause incorrect behavior
#       and will be lost if the state is redeployed.
#   </auto-generated>

    server {
        listen 80;
        listen [::]:80;
        server_name {{ fqdn }} {{ hostname }}.nasqueron.drake localhost {{ ips }};

        include includes/tls;
        ssl_certificate /usr/local/etc/letsencrypt/live/{{ fqdn }}/fullchain.pem;
        ssl_certificate_key /usr/local/etc/letsencrypt/live/{{ fqdn }}/privkey.pem;

        include includes/letsencrypt;

        ###
        ### Cover pages
        ###

        root /var/wwwroot/nasqueron.org/{{ hostname }};
        index index.html index.htm;

        ###
        ### API
        ###

        location ~ ^/datasources/.*\.json(/|$) {
            include includes/cors-open;
        }

        ###
        ### public_html user directories
        ###

        set $userdir public_html;

        location ~ ^/~(.+?)(/.*)?$ {
            alias /var/home-wwwroot/$1$2;
            index index.html index.htm;

            autoindex on;
            charset utf-8;
        }

        ###
        ### Misc directories
        ###

        location /poudriere {
            alias /usr/local/poudriere/data/logs/bulk;
            autoindex on;
        }

    }
