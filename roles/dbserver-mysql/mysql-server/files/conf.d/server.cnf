#   -------------------------------------------------------------
#   MariaDB configuration :: servers
#   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#   Project:        Nasqueron
#   License:        Trivial work, not eligible to copyright
#   Source file:    roles/dbserver-mysql/mysql-server/files/conf.d/server.cnf
#   -------------------------------------------------------------
#
#   <auto-generated>
#       This file is managed by our rOPS SaltStack repository.
#
#       Changes to this file may cause incorrect behavior
#       and will be lost if the state is redeployed.
#   </auto-generated>

#   -------------------------------------------------------------
#   Server wrapper
#   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

[mariadb-safe]
pid-file = /var/run/mysql/mysqld.pid
socket = /var/run/mysql/mysqld.sock
nice = 0

#   -------------------------------------------------------------
#   Generic server settings
#   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

[mysqld]
user				= mysql
pid-file = /var/run/mysql/mysqld.pid

basedir = /usr
tmpdir = /tmp
datadir = /var/db/mysql/data
lc-messages-dir = {{ share }}/mysql

bind-address			= {{ listen_ip }}
socket = /var/run/mysql/mysqld.sock
port = 3306

net_retry_count			= 16384
log_error			= /var/log/mysql/mysqld.err

sql_mode = STRICT_ALL_TABLES
explicit_defaults_for_timestamp

log_bin
log_basename = {{ nodename }}
binlog_cache_size = 1M
max_binlog_size = 1000M
binlog_expire_logs_seconds = 1209600  # 14 days
binlog_format = MIXED

#   -------------------------------------------------------------
#   InnoDB / XtraDB configuration
#   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

default-storage-engine = InnoDB
innodb_buffer_pool_size = 410M

{% if use_zfs %}
innodb_data_home_dir = /var/db/mysql/mysql-innodb-data
innodb_log_group_home_dir = /var/db/mysql/mysql-innodb-logs

innodb_file_per_table = off

innodb_doublewrite		= 0
innodb_flush_method		= O_DSYNC

{% endif %}

#   -------------------------------------------------------------
#   Performance schema
#
#   Wikimedia production servers on s3 have this configuration
#   with only 100MB of overhead. This is an acceptable cost
#   for a valuable information.
#
#   Reference: https://phabricator.wikimedia.org/T99485
#   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

performance_schema = 1

performance_schema_max_thread_instances                = 500
performance_schema_max_cond_instances                  = 1000
performance_schema_accounts_size                       = 300
performance_schema_hosts_size                          = 300
performance_schema_events_statements_history_size      = 10
performance_schema_events_statements_history_long_size = 1000
performance_schema_events_waits_history_size           = 10
performance_schema_events_waits_history_long_size      = 1000
performance_schema_events_stages_history_size          = 10
performance_schema_events_stages_history_long_size     = 1000
performance_schema_max_mutex_instances                 = 5000
performance_schema_max_rwlock_instances                = 2000
performance_schema_max_socket_instances                = 500
performance_schema_max_table_instances                 = 1000

#   -------------------------------------------------------------
#   Applications configuration
#
#     :: Phabricator
#
#   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Phabricator
max_allowed_packet = 32M
ft_stopword_file = {{ etc }}/mysql/stopwords.txt
ft_min_word_len = 3
ft_boolean_syntax = ' |-><()~*:""&^'
