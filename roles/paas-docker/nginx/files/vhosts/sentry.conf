#   -------------------------------------------------------------
#   Configuration for Docker PaaS front-end nginx
#   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#   Author:         SÃ©bastien Santoro aka Dereckson
#   Source file:    roles/paas-docker/nginx/files/vhosts/sentry.conf
#   -------------------------------------------------------------
#
#   <auto-generated>
#       This file is managed by our rOPS SaltStack repository.
#
#       Changes to this file may cause incorrect behavior
#       and will be lost if the state is redeployed.
#   </auto-generated>

server {
    listen 80;
    listen [::]:80;
    server_name {{ fqdn }};

    include includes/letsencrypt;

    return 301 https://$host$request_uri;
}

server {
    server_name {{ fqdn }};

    include includes/tls;
    ssl_certificate /srv/letsencrypt/etc/live/{{ fqdn }}/fullchain.pem;
    ssl_certificate_key /srv/letsencrypt/etc/live/{{ fqdn }}/privkey.pem;

    include includes/letsencrypt;

    include includes/proxy_params;
    proxy_redirect off;

    location /api/store/ {
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        proxy_temp_file_write_size 256k;

        proxy_pass http://localhost:{{ args.relay_port }};
    }

    location ~ ^/api/[1-9]\d*/ {
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        proxy_temp_file_write_size 256k;

        proxy_pass http://localhost:{{ args.relay_port }};
    }

    location / {
        proxy_pass http://localhost:{{ app_port }};
    }

    location /.well-known/change-password {
        return 301 https://$host/settings/account/security/;
    }

    root /var/wwwroot-502/_default;
    error_page 502 /502.html;
    location /502.html {}

    error_log /var/log/www/{{ service }}/{{ instance }}-error.log;
    access_log /var/log/www/{{ service }}/{{ instance }}-access.log;
}
