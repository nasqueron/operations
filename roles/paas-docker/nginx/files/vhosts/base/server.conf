#   -------------------------------------------------------------
#   Configuration for Docker PaaS front-end nginx
#   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#   Author:         SÃ©bastien Santoro aka Dereckson
#   Created:        2020-02-18
#   Source file:    roles/paas-docker/nginx/files/vhosts/base/server.conf
#   -------------------------------------------------------------
#
#   <auto-generated>
#       This file is managed by our rOPS SaltStack repository.
#
#       Changes to this file may cause incorrect behavior
#       and will be lost if the state is redeployed.
#   </auto-generated>

#   -------------------------------------------------------------
#   TLS site
#   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

server {
    listen 80;
    listen [::]:80;
    server_name {{ fqdn }};

    include includes/letsencrypt;

    return 301 https://{{ fqdn }}$request_uri;
}

server {
    server_name {{ fqdn }};

    include includes/tls;
    ssl_certificate /srv/letsencrypt/etc/live/{{ fqdn }}/fullchain.pem;
    ssl_certificate_key /srv/letsencrypt/etc/live/{{ fqdn }}/privkey.pem;

    include includes/letsencrypt;

    root   /var/wwwroot-content/{{ fqdn }};
    index  index.html;

    error_log /var/log/www/_server/base-error.log;
    access_log /var/log/www/_server/base-access.log;

    ###
    ### API
    ###

    location ~ [^/]\.json(/|$) {
        include includes/cors-open;
    }
}

#   -------------------------------------------------------------
#   Probably not any TLS certificate available, so serve on :80
#   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

server {
    listen 80;
    listen [::]:80;
    server_name {{ ipv4 }} {{ ipv6 }} localhost;

    error_log /var/log/www/_server/base-error.log;
    access_log /var/log/www/_server/base-access.log;

    location / {
        root   /var/wwwroot-content/{{ fqdn }};
        index  index.html;
    }
}
